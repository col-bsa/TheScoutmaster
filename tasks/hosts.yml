- name: Create web directories
  file:
    path: /var/www/{{ item }}
    state: directory
    mode: 0750
  with_items: "{{ virtual_hosts }}"

- name: Create virtual hosts
  copy:
    src: /etc/apache2/sites-available/000-default.conf
    dest: /etc/apache2/sites-available/{{ item }}.conf
    remote_src: yes
    owner: www-data
    group: www-data
    mode: 0664
    force: yes
  with_items: "{{ virtual_hosts }}"

- name: Update ServerAdmin Email
  lineinfile:
    path: /etc/apache2/sites-available/{{ item }}.conf
    regexp: "ServerAdmin webmaster@localhost"
    line: "        ServerName {{ item }}\n        ServerAdmin {{ admin_email }}"
    state: present
  with_items: "{{ virtual_hosts }}"

- name: Update DocumentRoot
  lineinfile:
    path: /etc/apache2/sites-available/{{ item }}.conf
    regexp: "        DocumentRoot /var/www/html"
    line: "        DocumentRoot /var/www/{{ item }}/public_html"
    state: present
  with_items: "{{ virtual_hosts }}"

- name: Update virtual host directory
  lineinfile:
    path: /etc/apache2/sites-available/{{ item }}.conf
    regexp: "        <Directory /var/www/html/>"
    line: "        <Directory /var/www/{{ item }}/public_html/>"
    state: present
  with_items: "{{ virtual_hosts }}"

- name: Make .ssh directory
  file:
    path: /var/www/.ssh
    state: directory
    owner: www-data
    group: www-data
    mode: 0700

- name: Copy github ssh key to new machine (root)
  copy:
    src: files/id_rsa
    dest: /root/.ssh/id_rsa
    mode: 0600

- name: Copy github ssh key to new machine (www-data)
  copy:
    src: files/id_rsa
    dest: /var/www/.ssh/id_rsa
    mode: 0600

- name: Ensure github.com is a known host (root)
  lineinfile:
    dest: /root/.ssh/known_hosts
    create: yes
    state: present
    line: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    regexp: "^github\\.com"

- name: Copy known_hosts to www
  copy:
    src: /root/.ssh/known_hosts
    dest: /var/www/.ssh/known_hosts
    remote_src: yes
    mode: 0600
    force: no

- name: Clone git repos
  shell: "git clone -b {{ item.value.branch }} --single-branch git@github.com:{{ github_owner }}/{{ item.value.repo }}.git public_html"
  args:
    chdir: /var/www/{{ item.key }}/
  with_dict: "{{ virtual_hosts }}"

- name: Move .git file
  shell: "mv .git/ ../git/"
  args:
    chdir: /var/www/{{ item }}/public_html/
  with_items: "{{ virtual_hosts }}"

- name: Make .git file
  lineinfile:
    dest: /var/www/{{ item }}/public_html/.git
    create: yes
    state: present
    line: "gitdir: ../git/"
  with_items: "{{ virtual_hosts }}"

- name: Make post-merge
  copy:
    src: files/post-merge
    dest: /var/www/{{ item }}/git/hooks/post-merge
    mode: 0770
  with_items: "{{ virtual_hosts }}"

- name: Update post-merge github ownername
  lineinfile:
    path: /var/www/{{ item.key }}/git/hooks/post-merge
    regexp: "GITHUB_OWNERNAME=\"YOUR_OWNERNAME\"\n
    GITHUB_REPONAME=\"YOUR_REPONAME\"\n
    SLACK_HOOK=\"YOUR_SLACKHOOK\"\n
    SLACK_CHANNEL=\"YOUR_SLACKCHANNEL\"\n
    SLACK_USER=\"YOUR_SLACKUSER\""
    line: "GITHUB_OWNERNAME=\"\"\n
    GITHUB_REPONAME=\"{{ item.value.repo }}\"\n
    SLACK_HOOK=\"{{ slack_hook }}\"\n
    SLACK_CHANNEL=\"{{ slack_channel }}\"\n
    SLACK_USER=\"{{ slack_user }}\""
    state: present
  with_dict: "{{ virtual_hosts }}"

- name: Change ownership of all new files
  file:
    path: /var/www/
    owner: www-data
    group: www-data
